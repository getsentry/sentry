variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - prepare
  - run
  - build

builder-image:
  stage: prepare
  image: docker-reg.devops.xiaohongshu.com/library/docker:v1.0
  before_script:
    - docker login -u $REGISTRY_USERNAME -p $REGISTRY_PASSWORD $REGISTRY_NAME
    - docker pull $REGISTRY_NAME/infra/sentry:builder || true
  script:
    - >
      docker build --rm --pull \
        -f ./docker/builder.dockerfile \
        -t $REGISTRY_NAME/infra/sentry:builder \
        --cache-from $REGISTRY_NAME/infra/sentry:builder \
        .
    - docker push $REGISTRY_NAME/infra/sentry:builder
  except:
    - tags

run-builder:
  stage: run
  image: docker-reg.devops.xiaohongshu.com/infra/sentry:builder
  script:
    - echo RUN BUILDER
    - bash /builder.sh
  artifacts:
    paths:
      - node_modules/
      - dist/
    untracked: false
    expire_in: 30 min
  except:
    - tags

sentry-image:
  stage: build
  image: docker-reg.devops.xiaohongshu.com/library/docker:v1.0
  dependencies:
    - run-builder
  before_script:
    - docker login -u $REGISTRY_USERNAME -p $REGISTRY_PASSWORD $REGISTRY_NAME
    - docker pull $REGISTRY_NAME/infra/sentry:latest || true
  script:
    - export BRANCH_PREFIX=${CI_COMMIT_REF_NAME//[\/|_]/-}
    - >
      docker build --rm --pull \
        -f ./docker/Dockerfile \
        -t $REGISTRY_NAME/infra/sentry:${BRANCH_PREFIX}-${CI_COMMIT_SHA:0:8} \
        -t $REGISTRY_NAME/infra/sentry:latest \
        --cache-from $REGISTRY_NAME/infra/sentry:latest \
        .
    - docker push $REGISTRY_NAME/infra/sentry:${BRANCH_PREFIX}-${CI_COMMIT_SHA:0:8}
    - docker push $REGISTRY_NAME/infra/sentry:latest
  except:
    - tags
