#!/usr/bin/env bash

red="$(tput setaf 1)"
bold="$(tput bold)"
reset="$(tput sgr0)"

files_changed_upstream="$(mktemp)"
trap "rm -f ${files_changed_upstream}" EXIT

git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD > "$files_changed_upstream"

grep -E --quiet 'requirements.*\.txt' "$files_changed_upstream" && py="install-sentry-dev "
grep -E --quiet 'yarn.lock' "$files_changed_upstream"           && js="install-yarn-pkgs "
grep -E --quiet 'migrations' "$files_changed_upstream"          && migrations="apply-migrations "

update_command="make ${py}${js}${migrations}"

[[ "$py" || "$js" || "$migrations" ]] && cat <<EOF

[${red}${bold}!!!${reset}] ${red}The following dependencies have changed and require your intervention${reset}
EOF

[[ "$py" ]] && cat <<EOF
    ${red}* python virtual environment${reset}
EOF

[[ "$js" ]] && cat <<EOF
    ${red}* javascript dependencies${reset}
EOF

[[ "$migrations" ]] && cat <<EOF
    ${red}* database migrations${reset}
EOF

[[ "$py" || "$js" || "$migrations" ]] && cat <<EOF

${red}Run ${bold}${update_command}${reset}${red}to update necessary dependencies${reset}

EOF


echo "Do you want to run updates now? [y/n] "
read answer
if [ "$answer" = "y" ]; then
  $update_command
fi
