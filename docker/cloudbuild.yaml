steps:
# Build the main getsentry/sentry image
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '--build-arg', 'SOURCE_COMMIT=$COMMIT_SHA', '-t', 'gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA', '-t', 'gcr.io/$PROJECT_ID/sentry:$SHORT_SHA', '-t', 'gcr.io/$PROJECT_ID/sentry:latest', '-f', './docker/Dockerfile', '.' ]
# Derive the -onbuild variant
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA-onbuild', '-t', 'gcr.io/$PROJECT_ID/sentry:$SHORT_SHA-onbuild', '-t', 'gcr.io/$PROJECT_ID/sentry:latest-onbuild', '-f', './docker/onbuild/Dockerfile', '.' ]
# Smoke tests
- name: 'gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA'
  args: ['config', 'get', 'system.secret-key']
  env:
    - SENTRY_SKIP_BACKEND_VALIDATION=1
    - SENTRY_SECRET_KEY=abc
    - SENTRY_REDIS_HOST=localhost
timeout: 1200s
images:
- 'gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA'
- 'gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA-onbuild'
- 'gcr.io/$PROJECT_ID/sentry:$SHORT_SHA'
- 'gcr.io/$PROJECT_ID/sentry:$SHORT_SHA-onbuild'
- 'gcr.io/$PROJECT_ID/sentry:latest'
- 'gcr.io/$PROJECT_ID/sentry:latest-onbuild'
