#!/bin/bash

set -ex;

if [[ -z "$SOURCE_COMMIT" ]]; then
	export SOURCE_COMMIT="${SOURCE_COMMIT:-$(git rev-parse HEAD)}";
	echo "Updating SOURCE_COMMIT from 'git rev-parse HEAD'";
fi

echo "SOURCE_COMMIT: $SOURCE_COMMIT";
echo $(pwd);
cd "$(git rev-parse --show-toplevel)/docker";
mkdir onpremise;
cd onpremise;
curl -Ls "https://github.com/getsentry/onpremise/archive/v10.tar.gz" | tar -xzf - --strip-components=1;
export SENTRY_IMAGE=getsentry/sentry:git;
./install.sh;
docker-compose run --rm web createuser --superuser --email test@sentry.io --password test123TEST;
docker-compose up -d
timeout 60 bash -c 'until $(curl -Isf -o /dev/null http://localhost:9000); do printf '.'; sleep 0.5; done'
