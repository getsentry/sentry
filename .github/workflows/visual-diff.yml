# This action only shows up under the "Actions" tab on the repo's Github page
# Nevertheless, it will cause the Visual Snapshot to trigger
name: visual diff
on:
  # This allows PRs opened from forks to execute the Visual Snapshots
  # since secrets are not passed to workflows when triggered via forks.
  workflow_run:
    workflows:
      - acceptance
    types:
      - completed

jobs:
  visual-diff:
    # https://docs.github.com/en/enterprise-server@3.2/actions/using-workflows/events-that-trigger-workflows#running-a-workflow-based-on-the-conclusion-of-another-workflow
    if: github.repository == 'getsentry/sentry' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-20.04
    timeout-minutes: 20

    steps:
      - name: Diff snapshots
        id: visual-snapshots-diff
        uses: getsentry/action-visual-snapshot@v2
        with:
          api-token: ${{ secrets.VISUAL_SNAPSHOT_SECRET }}
          gcs-bucket: 'sentry-visual-snapshots'
          gcp-service-account-key: ${{ secrets.SNAPSHOT_GOOGLE_SERVICE_ACCOUNT_KEY }}
