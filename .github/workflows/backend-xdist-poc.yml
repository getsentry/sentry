name: "[POC] backend xdist"

on:
  workflow_dispatch:
  push:
    branches:
      - mchen/service-classification-poc

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  SEGMENT_DOWNLOAD_TIMEOUT_MINS: 3
  SNUBA_NO_WORKERS: 1

jobs:
  xdist-test:
    name: "xdist (${{ matrix.instance }})"
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        instance: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]

    env:
      MATRIX_INSTANCE_TOTAL: 22
      TEST_GROUP_STRATEGY: roundrobin
      # Fixed hash seed ensures deterministic dict/set iteration across xdist workers,
      # preventing "Different tests were collected" errors from parametrized tests.
      PYTHONHASHSEED: "0"

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup sentry env
        uses: ./.github/actions/setup-sentry
        id: setup
        with:
          mode: backend-ci

      - name: "Phase 1: Non-snuba tests (xdist -n2)"
        run: |
          echo "=== Phase 1: non-ClickHouse tests with xdist parallelism ==="
          python3 -b -m pytest \
            tests \
            --reuse-db \
            --ignore tests/acceptance \
            --ignore tests/apidocs \
            --ignore tests/js \
            --ignore tests/tools \
            --xdist-snuba-phase=exclude \
            -n 2 \
            --dist=loadfile \
            --json-report \
            --json-report-file=".artifacts/pytest-phase1.json" \
            --json-report-omit=log \
            --junit-xml=.artifacts/pytest-phase1.junit.xml \
            -o junit_suite_name=pytest-non-snuba

      - name: "Phase 2: Snuba tests (single-threaded)"
        run: |
          echo "=== Phase 2: ClickHouse-dependent tests, single-threaded ==="
          python3 -b -m pytest \
            tests \
            --reuse-db \
            --ignore tests/acceptance \
            --ignore tests/apidocs \
            --ignore tests/js \
            --ignore tests/tools \
            --xdist-snuba-phase=only \
            --json-report \
            --json-report-file=".artifacts/pytest-phase2.json" \
            --json-report-omit=log \
            --junit-xml=.artifacts/pytest-phase2.junit.xml \
            -o junit_suite_name=pytest-snuba

      - name: Inspect failure
        if: failure()
        run: |
          if command -v devservices; then
            devservices logs
          fi
