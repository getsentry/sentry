name: "[POC] backend xdist"

on:
  workflow_dispatch:
  push:
    branches:
      - mchen/service-classification-poc

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  SEGMENT_DOWNLOAD_TIMEOUT_MINS: 3
  SNUBA_NO_WORKERS: 1

jobs:
  xdist-test:
    name: "xdist (${{ matrix.instance }})"
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        instance: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]

    env:
      MATRIX_INSTANCE_TOTAL: 22
      TEST_GROUP_STRATEGY: roundrobin

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup sentry env
        uses: ./.github/actions/setup-sentry
        id: setup
        with:
          mode: backend-ci

      - name: Run tests with xdist -n2 --dist=loadfile
        run: |
          # Strip --reruns from PYTEST_ADDOPTS (incompatible with xdist)
          export PYTEST_ADDOPTS=$(echo "$PYTEST_ADDOPTS" | sed 's/--reruns=[0-9]*//')
          echo "PYTEST_ADDOPTS=$PYTEST_ADDOPTS"
          python3 -b -m pytest \
            tests \
            --reuse-db \
            --ignore tests/acceptance \
            --ignore tests/apidocs \
            --ignore tests/js \
            --ignore tests/tools \
            -n 2 \
            --dist=loadfile \
            --json-report \
            --json-report-file=".artifacts/pytest.json" \
            --json-report-omit=log \
            --junit-xml=.artifacts/pytest.junit.xml \
            -o junit_suite_name=pytest

      - name: Inspect failure
        if: failure()
        run: |
          if command -v devservices; then
            devservices logs
          fi
