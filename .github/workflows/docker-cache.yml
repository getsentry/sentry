name: docker cache
on:
  # XXX: Make this run on a frequency OR on master
  # XXX: I wonder if caches can be shared across repositories
  pull_request:

jobs:
  # This job pull devservices images that are needed by our various workflows
  # We could potentially make this only run on
  docker-cache:
    name: Warm Docker cache
    runs-on: ubuntu-20.04
    timeout-minutes: 30
    steps:
      - name: Checkout sentry
        uses: actions/checkout@v2

      - uses: getsentry/action-docker-layer-caching@v0.0.11
        name: Docker Cache
        continue-on-error: true
        with:
          # Note: You must include {hash} in the key input. ({hash} is replaced
          # by the hash value of the Docker image when the action is executed.)
          key: docker-cache-{hash}
          restore-keys: |
            docker-cache-

      # See setup-sentry action and server.py
      - name: Pull images
        run: |
          # XXX: Ideally we have a script that iterates SENTRY_DEVSERVICES
          docker pull redis:5.0-alpine
          docker pull postgres:9.6-alpine
          docker pull confluentinc/cp-zookeeper:6.2.0
          docker pull confluentinc/cp-kafka:6.2.0
          docker pull getsentry/snuba:nightly
          docker pull yandex/clickhouse-server:20.3.9.70
          docker pull us.gcr.io/sentryio/cbtemulator:23c02d92c7a1747068eb1fc57dddbad23907d614
          # Images used as part of integration tests
          docker pull us.gcr.io/sentryio/symbolicator:nightly
          docker pull us.gcr.io/sentryio/relay:nightly
          docker pull us.gcr.io/sentryio/chartcuterie:nightly
