name: React to product-owners.yml changes
on:
  # This could be run manually, but the general expectation is that this fires
  # from GHA in getsentry/security-as-code on changes there.

  workflow_dispatch:
permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    name: React to product-owners.yml changes
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.1.7

      - uses: astral-sh/setup-uv@884ad927a57e558e7a70b92f2bccf9198a4be546 # v6
        with:
          version: '0.8.2'
          # we just cache the venv-dir directly in action-setup-venv
          enable-cache: false

      - uses: getsentry/action-setup-venv@5a80476d175edf56cb205b08bc58986fa99d1725 # v3.2.0
        with:
          cache-dependency-path: uv.lock
          install-cmd: echo

      - name: React to product-owners.yml changes
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.BUMP_SENTRY_TOKEN }}
          COMMITTER_NAME: getsentry-bot
          COMMITTER_EMAIL: bot@sentry.io
        run: |
          uv export --only-dev --no-hashes --no-annotate --no-header \
          | grep '^pyyaml' | sed -E 's/ ;.*//' \
          | xargs uv pip install --index-url 'https://pypi.devinfra.sentry.io/simple'

          ./bin/react-to-product-owners-yml-changes.sh
