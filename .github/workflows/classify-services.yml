name: classify test services

on:
  workflow_dispatch:
  push:
    branches:
      - mchen/service-classification-poc

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  SEGMENT_DOWNLOAD_TIMEOUT_MINS: 3
  SNUBA_NO_WORKERS: 1

jobs:
  classify:
    name: classify (${{ matrix.instance }})
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    permissions:
      contents: read
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        instance:
          [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]

    env:
      MATRIX_INSTANCE_TOTAL: 22
      TEST_GROUP_STRATEGY: roundrobin

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup sentry env
        uses: ./.github/actions/setup-sentry
        id: setup
        with:
          mode: backend-ci

      - name: Run tests with service classification (shard ${{ steps.setup.outputs.matrix-instance-number }} of 22)
        env:
          PYTEST_ADDOPTS: '${{ env.PYTEST_ADDOPTS }} --classify-services --classification-output=test-service-classification.json'
        run: |
          python3 -b -m pytest \
            tests \
            --reuse-db \
            --ignore tests/acceptance \
            --ignore tests/apidocs \
            --ignore tests/js \
            --ignore tests/tools \
            -o junit_suite_name=pytest \
            || true

      - name: Upload classification report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: classification-shard-${{ matrix.instance }}
          path: test-service-classification.json
          retention-days: 90

  merge-reports:
    name: merge classification reports
    needs: classify
    if: always()
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          pattern: classification-shard-*
          path: shards/

      - name: Merge shard reports
        run: |
          python3 - <<'SCRIPT'
          import json
          import os
          from collections import defaultdict
          from pathlib import Path

          merged_tests = defaultdict(set)
          for shard_dir in sorted(Path("shards").iterdir()):
              report_file = shard_dir / "test-service-classification.json"
              if not report_file.exists():
                  print(f"WARNING: {report_file} not found, skipping")
                  continue
              report = json.loads(report_file.read_text())
              for test_id, services in report.get("tests", {}).items():
                  # Union of services across shards - each shard has static
                  # results for all tests but runtime results only for its slice
                  merged_tests[test_id].update(services)

          # Build summary
          service_counts = defaultdict(int)
          tier_counts = defaultdict(int)
          for test_id, services in merged_tests.items():
              for service in services:
                  service_counts[service] += 1
              if "snuba" in services:
                  tier_counts["snuba_tier"] += 1
              elif services - {"postgres"}:
                  tier_counts["other_services"] += 1
              elif "postgres" in services:
                  tier_counts["postgres_only"] += 1
              else:
                  tier_counts["no_services"] += 1

          merged = {
              "total_tests": len(merged_tests),
              "summary": {
                  "service_counts": dict(service_counts),
                  "tier_counts": dict(tier_counts),
              },
              "tests": {k: sorted(v) for k, v in sorted(merged_tests.items())},
          }

          Path("test-service-classification.json").write_text(
              json.dumps(merged, indent=2) + "\n"
          )

          print(f"Merged {len(merged_tests)} tests from {len(list(Path('shards').iterdir()))} shards")
          print(f"\nService counts:")
          for svc, count in sorted(service_counts.items(), key=lambda x: -x[1]):
              print(f"  {svc}: {count}")
          print(f"\nTier breakdown:")
          for tier, count in sorted(tier_counts.items(), key=lambda x: -x[1]):
              print(f"  {tier}: {count}")
          SCRIPT

      - name: Upload merged report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: test-service-classification
          path: test-service-classification.json
          retention-days: 90
