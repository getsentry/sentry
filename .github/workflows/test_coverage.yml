name: Test coverage testing

on: [workflow_dispatch, workflow_call, pull_request]

jobs:
  backend-test-with-cov-context:
    name: backend test
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        instance:
          [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21]

    env:
      MATRIX_INSTANCE_TOTAL: 22

    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup sentry env
        uses: ./.github/actions/setup-sentry
        id: setup
        with:
          mode: backend-ci

      - name: Run backend test (${{ steps.setup.outputs.matrix-instance-number }} of ${{ steps.setup.outputs.matrix-instance-total }}) with --cov-context=test
        id: run_backend_tests
        run: |
          make test-python-ci COV_ARGS=--cov-context=test

      # Even if tests fail, gather the raw coverage sqlite DB(s)
      - name: Collect raw coverage database files
        if: ${{ always() }}
        shell: bash
        run: |
          set -euxo pipefail

          mkdir -p .artifacts/coverage_db

          # Copy raw coverage sqlite DB(s)
          shopt -s nullglob
          for f in .coverage .coverage.*; do
            cp -v "$f" .artifacts/coverage_db/
          done

          # If shards exist, combine into a single DB for convenience.
          if compgen -G ".artifacts/coverage_db/.coverage.*" > /dev/null; then
            # Combine shards from that directory; writes .coverage in current working dir
            coverage combine .artifacts/coverage_db || true
            if [[ -f .coverage ]]; then
              cp -v .coverage .artifacts/coverage_db/.coverage.combined
            fi
          else
            # No shards; make combined just a copy of the single DB
            if [[ -f .artifacts/coverage_db/.coverage ]]; then
              cp -v .artifacts/coverage_db/.coverage .artifacts/coverage_db/.coverage.combined
            fi
          fi

          # Quick sanity output (no heredoc)
          if [[ -f .artifacts/coverage_db/.coverage.combined ]]; then
            python -c "import os,sqlite3; p='.artifacts/coverage_db/.coverage.combined'; \
              print('coverage db:', p, os.path.getsize(p), 'bytes'); \
              con=sqlite3.connect(p); cur=con.cursor(); \
              print('tables:', [r[0] for r in cur.execute(\"select name from sqlite_master where type='table' order by 1\").fetchall()]); \
              print('files rows:', cur.execute('select count(*) from file').fetchone()[0] if cur.execute(\"select count(*) from sqlite_master where type='table' and name='file'\").fetchone() else 'n/a'); \
              print('context rows:', cur.execute('select count(*) from context').fetchone()[0] if cur.execute(\"select count(*) from sqlite_master where type='table' and name='context'\").fetchone() else 'n/a')"
          fi

      - name: List coverage artifact dir (debug)
        if: ${{ always() }}
        shell: bash
        run: |
          set -euxo pipefail
          pwd
          ls -la .artifacts || true
          ls -la .artifacts/coverage_db || true

      - name: Upload raw coverage sqlite as artifact
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: pycoverage-sqlite-${{ github.run_id }}-${{ steps.setup.outputs.matrix-instance-number }}
          path: ./.artifacts/coverage_db/*
          if-no-files-found: error
          retention-days: 7
          include-hidden-files: true

  combine-coverage:
    name: Combine coverage from all test jobs
    runs-on: ubuntu-24.04
    needs: backend-test-with-cov-context
    if: ${{ always() }}
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13.1'

      - name: Install coverage
        run: |
          pip install coverage[toml]

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pycoverage-sqlite-${{ github.run_id }}-*
          path: .artifacts/all-coverage
          merge-multiple: true

      - name: List downloaded artifacts (debug)
        run: |
          ls -la .artifacts/all-coverage || true
          find .artifacts/all-coverage -name ".coverage*" -type f || true

      - name: Combine all coverage databases
        run: |
          set -euxo pipefail
          mkdir -p .artifacts/combined-coverage

          # Copy all .coverage files from downloaded artifacts
          find .artifacts/all-coverage -name ".coverage" -o -name ".coverage.*" | while read f; do
            echo "Found coverage file: $f"
          done

          # Combine all coverage files into a single database
          coverage combine --keep .artifacts/all-coverage/.coverage*

          # Move the combined file to output directory
          if [[ -f .coverage ]]; then
            mv .coverage .artifacts/combined-coverage/.coverage.combined
          fi

      - name: Generate coverage report (debug)
        run: |
          if [[ -f .artifacts/combined-coverage/.coverage.combined ]]; then
            python -c "import os,sqlite3; p='.artifacts/combined-coverage/.coverage.combined'; \
              print('Combined coverage db:', p, os.path.getsize(p), 'bytes'); \
              con=sqlite3.connect(p); cur=con.cursor(); \
              print('tables:', [r[0] for r in cur.execute(\"select name from sqlite_master where type='table' order by 1\").fetchall()]); \
              print('file rows:', cur.execute('select count(*) from file').fetchone()[0] if cur.execute(\"select count(*) from sqlite_master where type='table' and name='file'\").fetchone() else 'n/a'); \
              print('context rows:', cur.execute('select count(*) from context').fetchone()[0] if cur.execute(\"select count(*) from sqlite_master where type='table' and name='context'\").fetchone() else 'n/a')"
          fi

      - name: Upload combined coverage database
        uses: actions/upload-artifact@v4
        with:
          name: pycoverage-sqlite-combined-${{ github.run_id }}
          path: .artifacts/combined-coverage/.coverage.combined
          if-no-files-found: error
          retention-days: 30
          include-hidden-files: true
