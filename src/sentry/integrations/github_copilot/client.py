from __future__ import annotations

import logging

from sentry.integrations.coding_agent.client import CodingAgentClient
from sentry.integrations.coding_agent.models import CodingAgentLaunchRequest
from sentry.integrations.github_copilot.models import (
    GithubCopilotJobRequest,
    GithubCopilotJobResponse,
    GithubCopilotPRConfig,
)
from sentry.seer.autofix.utils import CodingAgentProviderType, CodingAgentState, CodingAgentStatus

logger = logging.getLogger(__name__)


class GithubCopilotAgentClient(CodingAgentClient):
    integration_name = "github_copilot"
    base_url = "https://api.githubcopilot.com"

    def __init__(self, user_access_token: str):
        super().__init__()
        self.token = user_access_token

    def _get_auth_headers(self) -> dict[str, str]:
        return {
            "Authorization": f"Bearer {self.token}",
            "User-Agent": "sentry",
        }

    def launch(self, *, webhook_url: str, request: CodingAgentLaunchRequest) -> CodingAgentState:
        owner = request.repository.owner
        repo = request.repository.name

        payload = GithubCopilotJobRequest(
            problem_statement=request.prompt,
            content_filter_mode="hidden_characters",
            pull_request=GithubCopilotPRConfig(
                title=f"fix: {request.branch_name}",
                body_suffix="\n\n---\nðŸ¤– Generated by Sentry + GitHub Copilot",
            ),
            run_name="Sentry Issue Fix",
            event_type="sentry",
        )

        logger.info(
            "coding_agent.github_copilot.launch",
            extra={
                "owner": owner,
                "repo": repo,
                "agent_type": self.__class__.__name__,
            },
        )

        api_response = self.post(
            f"/agents/swe/v1/jobs/{owner}/{repo}",
            headers={
                "content-type": "application/json;charset=utf-8",
                **self._get_auth_headers(),
            },
            data=payload.dict(exclude_none=True),
            json=True,
            timeout=60,
        )

        print(f"GitHub Copilot API Response: status={api_response.status_code}, body={api_response.json}, text={api_response.text}")
        logger.info(
            "coding_agent.github_copilot.response",
            extra={
                "owner": owner,
                "repo": repo,
                "status_code": api_response.status_code,
                "response_body": api_response.json,
                "response_text": api_response.text,
            },
        )

        job_response = GithubCopilotJobResponse.validate(api_response.json)

        return CodingAgentState(
            id=job_response.job_id,
            status=CodingAgentStatus.RUNNING,
            provider=CodingAgentProviderType.GITHUB_COPILOT_AGENT,
            name=f"GitHub Copilot Job {job_response.job_id}",
            started_at=job_response.created_at,
            agent_url=None,
        )
