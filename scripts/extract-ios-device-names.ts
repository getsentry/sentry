/* eslint-env node */
import path from 'path';
import fs from 'fs';

import process from 'process';
console.log('Current working directory: ', process.cwd());

//joining path of directory
const outputPath = path.join(__dirname, '../static/app/constants/ios-device-list.tsx');
const directoryPath = path.join(__dirname, '../node_modules/ios-device-list/');

try {
  if (fs.statSync(outputPath)) {
    console.log('Regenerating ios-device-list.tsx...');
    fs.unlinkSync(outputPath);
  }
} catch (e) {
  // File does not exists, carry along
}

async function getDefinitionFiles(): Promise<string[]> {
  const files: string[] = [];

  const maybeJSONFiles = await fs.readdirSync(directoryPath);

  //listing all files using forEach
  maybeJSONFiles.forEach(file => {
    if (!file.endsWith('.json') || file === 'package.json') return;

    files.push(path.join(path.resolve(directoryPath), file));
  });

  return files;
}

type Generation = string;
type Identifier = string;

type Mapping = Record<Identifier, Generation>;

async function collectDefinitions(files: string[]): Promise<Mapping> {
  const definitions: Mapping = {};

  const queue = [...files];

  while (queue.length > 0) {
    const file = queue.pop();
    const content = JSON.parse(fs.readFileSync(file, 'utf-8'));

    if (typeof content?.[0]?.Identifier === 'undefined') {
      continue;
    }

    for (let i = 0; i < content.length; i++) {
      definitions[content[i].Identifier] = content[i].Generation;
    }
  }

  return definitions;
}

const HEADER = `
// THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
// generated using scripts/extract-ios-device-names.ts as part of yarn post-install step.
// the purpose of the script is to extract only the iOS information that Sentry cares about
// and discard the rest of the JSON so we do not end up bloating bundle size.
`;

const template = (contents: string) => {
  return `
${HEADER}
const iOSDeviceMapping: Record<string, string> = ${contents}

export {iOSDeviceMapping}
  `;
};

async function extractIOSDeviceNames() {
  const files = await getDefinitionFiles();
  const definitions = await collectDefinitions(files);
  fs.writeFileSync(outputPath, template(JSON.stringify(definitions, undefined, 2)));
}

(async () => {
  await extractIOSDeviceNames();
})();
